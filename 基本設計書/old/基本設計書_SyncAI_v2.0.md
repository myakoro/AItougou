# 基本設計書：AI統合回答アプリ（SyncAI）

**作成日**: 2025年12月19日  
**バージョン**: 2.0  
**ドキュメント種別**: 基本設計書

---

## 1. システム構成

### 1.1 システム構成図

```
┌──────────────────────────────────┐
│     デスクトップアプリ           │
│  (Windows 11 専用)               │
├──────────────────────────────────┤
│                                  │
│  ┌────────────┐  ┌────────────┐ │
│  │   UI層     │  │ビジネス     │ │
│  │  (View)    │←→│ロジック層  │ │
│  └────────────┘  └──────┬─────┘ │
│                         ↓        │
│                  ┌────────────┐  │
│                  │ データ層   │  │
│                  │ (Local DB) │  │
│                  └────────────┘  │
└──────────────────┬───────────────┘
                   ↓
         ┌─────────┴─────────┐
         ↓                   ↓
   ┌──────────┐        ┌──────────┐
   │ ChatGPT  │        │Perplexity│
   │   API    │        │   API    │
   └──────────┘        └──────────┘
         ↑
         │
   ┌──────────┐
   │  GitHub  │
   │ (models  │
   │  .json)  │
   └──────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 | 備考 |
|---------|------|------|
| フロントエンド | HTML/CSS/JavaScript | シンプルなUI |
| フレームワーク | Electron または Tauri | デスクトップアプリ化 |
| データベース | SQLite | ローカルDB |
| API通信 | fetch API | HTTPS通信 |
| 設定ファイル | JSON | ローカル保存 |

---

## 2. 画面設計

### 2.1 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| SC001 | メイン画面 | 質問入力、回答表示、スレッド管理 |
| SC002 | 設定画面 | APIキー設定、モデル選択 |

---

### 2.2 SC001: メイン画面

#### レイアウト

```
┌─────────────────────────────────────────┐
│ SyncAI                    [設定] [×]     │
├───────────┬─────────────────────────────┤
│           │                             │
│ スレッド  │     会話エリア              │
│ 一覧      │                             │
│           │  [質問1]                    │
│ [新規作成]│  → [回答1] [詳細を見る]     │
│           │                             │
│ ・スレ1   │  [質問2]                    │
│ ・スレ2   │  → [回答2] [詳細を見る]     │
│ ・スレ3   │                             │
│           │                             │
│           │                             │
│           │                             │
│           ├─────────────────────────────┤
│           │ [質問入力欄]                │
│           │ [送信] [処理状況: xxx]      │
└───────────┴─────────────────────────────┘
```

#### 構成要素

| 要素 | 説明 |
|------|------|
| スレッド一覧 | 左側パネル、スレッド名のリスト |
| 新規作成ボタン | 新しいスレッドを作成 |
| 会話エリア | 質問と回答の履歴を表示 |
| 詳細を見るボタン | TYPE_Bの場合に表示、クリックで詳細展開 |
| 質問入力欄 | テキストエリア、最大10,000文字 |
| 送信ボタン | 質問を送信 |
| 処理状況 | API呼び出し中の状態を表示 |

---

### 2.3 SC002: 設定画面

#### レイアウト

```
┌─────────────────────────────────────────┐
│ 設定                           [×]       │
├─────────────────────────────────────────┤
│                                         │
│ ■ ChatGPT API設定                       │
│   APIキー: [●●●●●●●●●●●●●●●●●●]      │
│                                         │
│   使用モデル:                           │
│   ○ GPT-5.2（最新・推奨）               │
│     最も高性能なフラッグシップ          │
│   ○ GPT-5（標準）                       │
│     汎用タスク向けベースモデル          │
│   ○ GPT-5-mini（軽量・高速）            │
│     低コスト・シンプルなタスク向け      │
│   ○ GPT-5-nano（超軽量）                │
│     大量処理・最小コスト                │
│                                         │
│ ■ Perplexity API設定                    │
│   APIキー: [●●●●●●●●●●●●●●●●●●]      │
│                                         │
│              [保存] [キャンセル]        │
└─────────────────────────────────────────┘
```

#### 構成要素

| 要素 | 説明 |
|------|------|
| ChatGPT APIキー入力 | マスク表示、半角英数字のみ |
| モデル選択ラジオボタン | 4つのモデルから選択 |
| Perplexity APIキー入力 | マスク表示、半角英数字のみ |
| 保存ボタン | 設定を保存して閉じる |
| キャンセルボタン | 設定を破棄して閉じる |

---

## 3. データベース設計

### 3.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| threads | スレッド情報 |
| messages | メッセージ情報 |

---

### 3.2 threads テーブル

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | TEXT | PRIMARY KEY | スレッドID（UUID） |
| name | TEXT | NOT NULL | スレッド名 |
| created_at | DATETIME | NOT NULL | 作成日時 |
| updated_at | DATETIME | NOT NULL | 更新日時 |

**インデックス:**
- updated_at（降順）

---

### 3.3 messages テーブル

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | TEXT | PRIMARY KEY | メッセージID（UUID） |
| thread_id | TEXT | NOT NULL, FOREIGN KEY | 所属スレッドID |
| sender | TEXT | NOT NULL | "user" または "ai" |
| question | TEXT | | 質問内容（userの場合） |
| answer | TEXT | | 統合回答（aiの場合） |
| question_type | TEXT | | "TYPE_A" または "TYPE_B" |
| check_items | TEXT | | 確認項目リスト（JSON形式） |
| perplexity_result | TEXT | | Perplexity調査結果 |
| created_at | DATETIME | NOT NULL | 送信日時 |

**インデックス:**
- thread_id, created_at（昇順）

---

## 4. 処理フロー設計

### 4.1 アプリ起動フロー

```
[アプリ起動]
    ↓
[models.json を GitHub から取得]
    ├→ 成功 → ローカル保存
    └→ 失敗（5秒タイムアウト） → ローカルファイル使用
    ↓
[APIキー設定チェック]
    ├→ 未設定 → 設定画面表示
    └→ 設定済 → メイン画面表示
```

**処理時間:** 合計3秒以内

---

### 4.2 AI統合回答生成フロー

```
[質問送信]
    ↓
[ステップ1: 質問分類 (ChatGPT)]
    ├→ TYPE_A → [ステップ2-A: 通常回答生成] → 表示
    └→ TYPE_B → [ステップ2-B: 確認項目抽出]
                     ↓
                [ステップ3: 最新情報調査 (Perplexity)]
                     ↓
                [ステップ4: 最終回答生成 (ChatGPT)]
                     ↓
                  表示
```

**処理時間:**
- TYPE_A: 3-5秒（API 2回）
- TYPE_B: 10-15秒（API 4回）

---

### 4.3 スレッド管理フロー

#### 新規作成

```
[新規作成ボタンクリック]
    ↓
[新しいスレッドをDBに作成]
    ↓
[スレッド一覧を更新]
    ↓
[新しいスレッドを選択状態にする]
```

#### スレッド切り替え

```
[スレッドをクリック]
    ↓
[該当スレッドのメッセージをDBから取得]
    ↓
[会話エリアに表示]
```

#### スレッド削除

```
[削除アイコンをクリック]
    ↓
[確認ダイアログ表示]
    ├→ キャンセル → 処理中断
    └→ 削除 → [該当スレッドと関連メッセージをDBから削除]
                  ↓
              [スレッド一覧を更新]
```

---

## 5. API通信設計

### 5.1 ChatGPT API

**エンドポイント:** `https://api.openai.com/v1/chat/completions`

**リクエスト形式:**
```json
{
  "model": "gpt-5.2",
  "messages": [
    {"role": "user", "content": "質問内容"}
  ],
  "temperature": 0.7
}
```

**レスポンス形式:**
```json
{
  "choices": [
    {
      "message": {
        "content": "回答内容"
      }
    }
  ]
}
```

---

### 5.2 Perplexity API

**エンドポイント:** （Perplexity公式ドキュメント参照）

**リクエスト形式:**
```json
{
  "query": "調査内容",
  "options": {
    "include_sources": true
  }
}
```

**レスポンス形式:**
```json
{
  "answer": "調査結果",
  "sources": [
    {"url": "https://..."}
  ]
}
```

---

### 5.3 GitHub models.json 取得

**URL:** `https://raw.githubusercontent.com/[user]/syncai-config/main/models.json`

**タイムアウト:** 5秒

**レスポンス形式:**
```json
{
  "version": "1.0",
  "last_updated": "2025-12-19",
  "chatgpt_models": [
    {
      "id": "gpt-5.2",
      "display_name": "GPT-5.2（最新・推奨）",
      "description": "最も高性能なフラッグシップ",
      "is_default": true
    }
  ]
}
```

---

## 6. ファイル/フォルダ構成

```
SyncAI/
├── app/
│   ├── main.js              # メイン処理
│   ├── ui/
│   │   ├── mainWindow.html  # メイン画面
│   │   ├── settings.html    # 設定画面
│   │   └── styles.css       # スタイル
│   ├── logic/
│   │   ├── aiIntegration.js # AI統合処理
│   │   ├── threadManager.js # スレッド管理
│   │   └── apiClient.js     # API通信
│   └── data/
│       ├── database.js      # DB操作
│       └── config.js        # 設定管理
├── data/
│   ├── syncai.db           # SQLiteデータベース
│   ├── config.json         # API設定
│   └── models.json         # モデルリスト
└── package.json
```

---

## 7. エラーハンドリング

### 7.1 エラー種別と対応

| エラー種別 | 検知方法 | 表示メッセージ | 対応 |
|-----------|---------|---------------|------|
| ChatGPT APIエラー | HTTPステータス ≠ 200 | ChatGPTからの応答取得に失敗しました | APIキー確認を促す |
| Perplexity APIエラー | HTTPステータス ≠ 200 | 最新情報の取得に失敗しました | APIキー確認を促す |
| ネットワークエラー | fetch例外 | ネットワーク接続に失敗しました | 接続確認を促す |
| タイムアウト | 30秒経過 | 応答時間が長すぎます | 処理中断 |
| GitHub取得失敗 | fetch例外 | （非表示） | ローカルファイル使用 |

---

## 8. セキュリティ設計

### 8.1 APIキーの保護

| 対策 | 実装方法 |
|------|---------|
| 暗号化保存 | AES-256で暗号化してconfig.jsonに保存 |
| マスク表示 | 設定画面では●●●で表示 |
| メモリ保護 | 使用後は速やかにメモリから削除 |

### 8.2 通信の保護

| 対策 | 実装方法 |
|------|---------|
| HTTPS通信 | すべてのAPI通信はHTTPS |
| 証明書検証 | 証明書の有効性を検証 |

---

## 9. 非機能要件の実現方法

### 9.1 パフォーマンス最適化

| 要件 | 実現方法 |
|------|---------|
| 応答時間3-15秒 | 並列処理は行わず、順次処理で確実性を優先 |
| スレッド切り替え1秒 | インデックスを活用したDB検索 |

### 9.2 データ永続化

| 要件 | 実現方法 |
|------|---------|
| ローカル保存 | SQLite + JSON |
| 保存場所 | ユーザーのドキュメントフォルダ |

---

## 10. テスト方針

### 10.1 単体テスト

- 各関数の入出力テスト
- エラーハンドリングのテスト

### 10.2 結合テスト

- API呼び出しの成功/失敗パターン
- スレッド管理の操作

### 10.3 UIテスト

- 画面遷移
- ボタン操作
- 入力バリデーション

---

## 11. 詳細設計への引き継ぎ事項

以下は詳細設計書で定義すること：

1. **各ステップのプロンプト設計**（動的日付対応含む）
2. **APIレスポンスのパース処理**
3. **エラーリトライロジック**
4. **UI状態管理の詳細**
5. **データベーストランザクション処理**
6. **models.json のバージョン管理ロジック**

