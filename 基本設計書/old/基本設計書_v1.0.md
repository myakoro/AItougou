# 基本設計書：AI統合回答アプリ（SyncAI）

**作成日**: 2025年12月16日  
**バージョン**: 1.0  
**ドキュメント種別**: 基本設計書  
**関連文書**: 要件定義書_SyncAI_20251216.md

---

## 1. システム概要

### 1.1 システム構成
本システムは、Windowsデスクトップアプリケーションとして動作し、以下の構成を持つ：

- **フロントエンド**: ユーザーインターフェース
- **ビジネスロジック層**: 機能処理
- **データアクセス層**: ローカルデータの読み書き
- **外部API連携層**: ChatGPT API、Perplexity APIとの通信

### 1.2 アーキテクチャパターン
- **MVC（Model-View-Controller）パターン**を採用
- 関心の分離により、保守性と拡張性を確保

---

## 2. 技術選定

### 2.1 開発環境・ツール

| 項目 | 選定技術 | 理由 |
|------|----------|------|
| 開発ツール | Google Bolt（Antigravity）またはWindsurf | 要件定義書の指定 |
| プログラミング言語 | JavaScript/TypeScript | デスクトップアプリ開発に適している |
| フレームワーク | Electron | Windowsデスクトップアプリを容易に作成可能 |
| UIライブラリ | React | コンポーネント指向で保守性が高い |
| スタイリング | Tailwind CSS | 迅速なUI開発が可能 |

### 2.2 データ保存

| 項目 | 選定技術 | 理由 |
|------|----------|------|
| データ保存形式 | JSON | 可読性が高く、JavaScriptとの親和性が高い |
| ファイルシステム | Node.js fs module | Electronで標準的に使用される |
| APIキー保護 | electron-store + 暗号化 | セキュアな保存が可能 |

- 暗号化は **electron-store の encryptionKey 機能を正**とし、アプリ側での二重暗号化は行わない。
- 暗号鍵は端末依存値（hostname等）から生成せず、同一端末内で復号不能になるリスクを避ける。

### 2.3 外部API連携

| 項目 | 選定技術 | 理由 |
|------|----------|------|
| HTTP通信 | axios | 使いやすく、エラーハンドリングが充実 |
| 並列処理 | Promise.all() | ChatGPTとPerplexityへの同時問い合わせに使用 |

---

## 3. システム全体構成

### 3.1 レイヤー構成

```
┌─────────────────────────────────────┐
│   Presentation Layer (UI)           │
│   - React Components                │
│   - メイン画面、設定画面            │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│   Business Logic Layer              │
│   - AI統合回答生成ロジック          │
│   - スレッド管理ロジック            │
│   - エラーハンドリング              │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│   Data Access Layer                 │
│   - ローカルストレージ管理          │
│   - データ読み書き                  │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│   External API Layer                │
│   - ChatGPT API連携                 │
│   - Perplexity API連携              │
└─────────────────────────────────────┘
```

### 3.2 コンポーネント構成

```
App
├── MainWindow
│   ├── Sidebar
│   │   ├── ThreadList
│   │   │   └── ThreadItem (複数)
│   │   └── NewThreadButton
│   ├── ChatArea
│   │   ├── ThreadHeader
│   │   ├── MessageList
│   │   │   └── MessageItem (複数)
│   │   │       └── MessageDetail (折りたたみ)
│   │   └── InputArea
│   │       ├── QuestionInput
│   │       └── SendButton
│   └── Header
│       └── SettingsButton
└── SettingsModal
    ├── APIKeyInput (ChatGPT)
    ├── APIKeyInput (Perplexity)
    ├── SaveButton
    └── CancelButton
```

---

## 4. データ設計

### 4.1 データ構造

#### スレッドデータ構造
```json
{
  "id": "string (UUID)",
  "name": "string (max 50)",
  "createdAt": "string (ISO 8601 datetime)",
  "updatedAt": "string (ISO 8601 datetime)",
  "messages": [
    // メッセージ配列
  ]
}
```

#### メッセージデータ構造
```json
{
  "id": "string (UUID)",
  "threadId": "string (UUID)",
  "sender": "user | ai",
  "questionContent": "string (max 10000) | null",
  "integratedResponse": "string (max 20000) | null",
  "chatgptResponse": "string (max 20000) | null",
  "perplexityResponse": "string (max 20000) | null",
  "timestamp": "string (ISO 8601 datetime)"
}
```

#### API設定データ構造
```json
{
  "chatgptApiKey": "string (encrypted)",
  "perplexityApiKey": "string (encrypted)"
}
```

### 4.2 ファイル配置

```
{userData}/
├── data/
│   └── threads.json                # スレッドデータ（JSON）
├── logs/
│   └── error-YYYY-MM-DD.log        # エラーログ（日次ローテーション）
└── config.json                     # electron-store 実体（API設定を暗号化保存）
```

※ {userData} は Electron の `app.getPath('userData')` で取得する。  
※ API設定は `config.json（electron-store）` を直接読む方式ではなく、**electron-store を正とする**（要件の「安全に保存」を満たすため）。

### 4.3 データ永続化方針

**保存タイミング**:
- スレッド作成時：即座に保存
- メッセージ追加時：即座に保存
- スレッド削除時：即座に保存
- API設定変更時：即座に保存

**データ整合性**:
- 書き込み前にバックアップを作成
- 書き込み失敗時はバックアップから復元

---

## 5. 処理設計

### 5.1 AI統合回答生成処理

**処理フロー設計**:
```
1. ユーザー入力受付
   ↓
2. バリデーション実行
   ↓
3. ユーザーメッセージをスレッドに保存
   ↓
4. 並列処理開始
   ├→ ChatGPT API呼び出し（会話履歴含む）
   └→ Perplexity API呼び出し
   ↓
5. 両方のレスポンス取得確認
   ├→ 失敗: エラー処理
   └→ 成功: 続行
   ↓
6. ChatGPT APIに統合プロンプトで再問い合わせ
   ↓
7. 統合回答取得
   ↓
8. AIメッセージをスレッドに保存
   ↓
9. UI更新
```

**タイムアウト処理**:
- 各API呼び出しに15秒のタイムアウト設定
- タイムアウト時はエラーハンドリング

**リトライ処理**:
- 一時的なネットワークエラーの場合、最大3回リトライ
- リトライ間隔：1秒、2秒、3秒

### 5.2 会話履歴管理

**会話履歴の送信方針**:
- 直近10往復分（20メッセージ）のみをAPI送信
- トークン数削減とコスト削減

**会話履歴のフォーマット**:
```javascript
[
  { role: "user", content: "質問1" },
  { role: "assistant", content: "回答1" },
  { role: "user", content: "質問2" },
  { role: "assistant", content: "回答2" },
  ...
]
```

### 5.3 統合回答生成プロンプト設計

**プロンプトテンプレート**:
```
以下の2つの回答を分析して、最新情報の正確性を踏まえた上で、論理的で実用的な統合回答を生成してください。

【ChatGPTの回答】
{chatgptResponse}

【Perplexityの回答（最新情報）】
{perplexityResponse}

【指示】
- Perplexityの情報が新しい場合は、その情報を優先してください
- 論理的な説明を加えてください
- 実用的で具体的な回答にしてください
- 2つの回答に矛盾がある場合は、どちらがより信頼できるか判断してください
```

---

## 6. 画面設計

### 6.1 画面遷移設計

```
[起動] → [APIキー設定済み？]
           ├→ No: [設定画面] → [メイン画面]
           └→ Yes: [メイン画面]

[メイン画面] ⇄ [設定画面]
```

### 6.2 メイン画面レイアウト設計

**レイアウト構成**:
```
┌────────────────────────────────────────────┐
│ [設定] [v1.0]                 [新規スレッド] │
├───────────┬────────────────────────────────┤
│           │  【スレッド名】                  │
│スレッド一覧│ ────────────────────────────── │
│           │                                │
│[新] 会話1  │  [ユーザー] 質問内容            │
│[新] 会話2  │  [AI] 統合回答                 │
│    会話3  │      [詳細を見る ▼]             │
│    会話4  │                                │
│           │  [ユーザー] 追加質問            │
│           │  [AI] 統合回答                 │
│           │                                │
│           ├────────────────────────────── │
│           │  [処理中: ChatGPTに問い合わせ中...]│
│           │  ┌──────────────────────────┐ │
│           │  │質問を入力...                │ │
│           │  └──────────────────────────┘ │
│           │                        [送信]  │
└───────────┴────────────────────────────────┘
```

**サイズ仕様**:
- ウィンドウ最小サイズ: 1280×720
- サイドバー幅: 250px（固定）
- メインエリア: 可変

### 6.3 設定画面レイアウト設計

**レイアウト構成**:
```
┌──────────────────────────────────┐
│  API設定                  [×]    │
├──────────────────────────────────┤
│                                  │
│  ChatGPT APIキー                 │
│  ┌────────────────────────────┐  │
│  │ ●●●●●●●●●●●●●●●●●●●●    │  │
│  └────────────────────────────┘  │
│                                  │
│  Perplexity APIキー              │
│  ┌────────────────────────────┐  │
│  │ ●●●●●●●●●●●●●●●●●●●●    │  │
│  └────────────────────────────┘  │
│                                  │
│         [キャンセル]  [保存]      │
└──────────────────────────────────┘
```

**モーダルサイズ**: 600×400

---

## 7. API連携設計

### 7.1 ChatGPT API連携

**エンドポイント**: `https://api.openai.com/v1/chat/completions`

**リクエストヘッダー**:
```javascript
{
  "Content-Type": "application/json",
  "Authorization": "Bearer {apiKey}"
}
```

**リクエストボディ**:
```javascript
{
  "model": "gpt-4",  // または gpt-3.5-turbo
  "messages": [
    // 会話履歴配列
  ],
  "max_tokens": 2000,
  "temperature": 0.7
}
```

**レスポンス処理**:
- ステータス200: 正常
- ステータス401: APIキーエラー
- ステータス429: レート制限エラー
- その他: 一般エラー

### 7.2 Perplexity API連携

**エンドポイント**: `https://api.perplexity.ai/chat/completions`

**リクエストヘッダー**:
```javascript
{
  "Content-Type": "application/json",
  "Authorization": "Bearer {apiKey}"
}
```

**リクエストボディ**:
```javascript
{
  "model": "sonar",
  "messages": [
    { "role": "user", "content": "{質問内容}" }
  ],
  "max_tokens": 2000
}
```

**レスポンス処理**:
- ChatGPT APIと同様

### 7.3 エラーハンドリング設計

**エラー種別マッピング（AppError.type）**:
```ts
type AppErrorType =
  | 'NETWORK_ERROR'
  | 'API_ERROR'
  | 'AUTH_ERROR'
  | 'TIMEOUT_ERROR'
  | 'STORAGE_ERROR'
  | 'UNKNOWN_ERROR'
```

**HTTP/事象 → AppError.type の変換例**:
- 401/403 → AUTH_ERROR（APIキー無効/権限）
- 429 → API_ERROR（レート制限：自動リトライしない）
- タイムアウト → TIMEOUT_ERROR（自動リトライ対象）
- 通信断/名前解決失敗 → NETWORK_ERROR（自動リトライ対象）
- ファイル保存/読み込み失敗 → STORAGE_ERROR
- その他 → UNKNOWN_ERROR


**エラーログ**:
- エラー発生時刻
- エラー種別
- エラーメッセージ
- スタックトレース
- リクエスト内容（APIキーは除外）

---

### 7.4 リトライ設計（要件反映：最大3回）

- 対象：NETWORK_ERROR / TIMEOUT_ERROR のみ
- 回数：最大3回（初回 + 再試行2回）
- 待機：1秒 → 2秒 → 3秒
- 目的：一時的なネットワーク揺らぎ・瞬断の吸収
- 非対象：AUTH_ERROR / API_ERROR（例：401, 429）は即時エラー返却




## 8. セキュリティ設計

### 8.1 APIキー保護

**暗号化方式**:
- AES-256-GCM暗号化
- 暗号化キーはOS固有の情報から生成

**保存場所**:
- `data/config.json（electron-store）`（暗号化済み）

**メモリ管理**:
- APIキーは使用時のみメモリに展開
- 使用後は速やかにメモリから削除

### 8.2 通信セキュリティ

**HTTPS通信**:
- すべてのAPI通信はHTTPS経由
- 証明書検証を実施

**タイムアウト**:
- 各API呼び出しに15秒のタイムアウト設定

---

## 9. パフォーマンス設計

### 9.1 応答時間目標

| 処理 | 目標時間 |
|------|----------|
| アプリ起動 | 3秒以内 |
| スレッド切り替え | 1秒以内 |
| AI統合回答生成 | 15秒以内 |

### 9.2 最適化方針

**並列処理**:
- ChatGPTとPerplexityへの問い合わせを並列実行
- `Promise.all()`を使用

**キャッシュ**:
- スレッドデータはメモリにキャッシュ
- ファイル読み込みは起動時とデータ更新時のみ

**レンダリング最適化**:
- 仮想スクロール（大量のメッセージがある場合）
- React.memoを活用したコンポーネントの再レンダリング抑制

---

## 10. エラーハンドリング設計

### 10.1 エラー分類

**レベル1（警告）**:
- 空白入力
- 文字数超過

**レベル2（エラー）**:
- APIキー未設定
- ネットワークエラー
- API呼び出しエラー

**レベル3（致命的エラー）**:
- データ保存失敗
- データ読み込み失敗
- 予期しないクラッシュ

### 10.2 エラーログ設計

**ログファイル**:
- `{userData}/logs/error-YYYY-MM-DD.log`
- ローテーション：1日ごと（起動時に当日ファイルへ切替）
- 保持：最大7日分（8日以上前は削除）

**ログフォーマット**:
```
[2025-12-16 10:30:45] [ERROR] API呼び出しエラー
Message: ChatGPTからの応答取得に失敗
Details: {
  "statusCode": 401,
  "endpoint": "https://api.openai.com/v1/chat/completions",
  "error": "Invalid API key"
}
```

---

## 11. テスト設計方針

### 11.1 テスト種別

**単体テスト**:
- 各関数・メソッドの動作確認
- カバレッジ目標：80%以上

**統合テスト**:
- API連携の動作確認
- データ保存・読み込みの動作確認

**E2Eテスト**:
- ユーザーシナリオベースのテスト
- 要件定義書の使用シナリオを実施

### 11.2 テスト環境

**モックAPI**:
- ChatGPT API、Perplexity APIのモック作成
- テスト用のダミーレスポンス

**テストデータ**:
- スレッドデータのサンプル作成
- エッジケースのデータ準備

---

## 12. 拡張性設計

### 12.1 将来の機能拡張への考慮

**他のAIサービス追加**:
- API連携層を抽象化
- プロバイダーインターフェースの定義

**プロバイダーインターフェース**:
```javascript
interface AIProvider {
  name: string;
  apiKey: string;
  query(question: string, history?: Message[]): Promise<string>;
}
```

**設定画面の拡張**:
- APIキー入力欄を動的に追加可能
- プロバイダー選択UI

### 12.2 モジュール分割

**モジュール構成**:
```
src/
├── components/        # UIコンポーネント
├── services/         # ビジネスロジック
│   ├── aiService.js      # AI統合処理
│   ├── threadService.js  # スレッド管理
│   └── storageService.js # データ永続化
├── api/              # API連携
│   ├── chatgptApi.js
│   └── perplexityApi.js
├── utils/            # ユーティリティ
│   ├── encryption.js
│   └── logger.js
└── constants/        # 定数定義
```

---

## 13. 運用設計

### 13.1 バージョン管理

**バージョン表示**:
- 画面右上に表示
- `v1.0.0`形式

**バージョンアップ方針**:
- メジャーバージョン：破壊的変更
- マイナーバージョン：機能追加
- パッチバージョン：バグ修正

### 13.2 ログ管理

**ログ種別**:
- エラーログ：`{userData}/logs/error-YYYY-MM-DD.log`
- アクセスログ：不要（ローカルアプリのため）

**ログ保持期間**:
- 7日分を保持
- 古いログは自動削除

---

## 14. ビルド・配布設計

### 14.1 ビルド方式

**Electronビルド**:
- `electron-builder`を使用
- Windows用実行ファイル（.exe）を生成

**ビルド成果物**:
- `SyncAI-Setup-1.0.0.exe`（インストーラー形式）
- または`SyncAI-1.0.0.exe`（ポータブル形式）

### 14.2 配布方式

**配布方法**:
- GitHubからダウンロード
- またはローカルでビルドして使用

**インストール**:
- インストーラー実行
- インストール先：`C:\Program Files\SyncAI\`
- データフォルダ：`C:\Users\{UserName}\AppData\Local\SyncAI\`

---

## 15. 詳細設計への引き継ぎ事項

### 15.1 実装時の注意点

**並列処理の実装**:
- `Promise.all()`を使用してChatGPTとPerplexityを並列呼び出し
- エラーハンドリングを各Promiseで個別に実装

**データ保存の実装**:
- 書き込み前にバックアップを作成
- JSON形式での保存

**暗号化の実装**:
- `crypto`モジュールを使用
- AES-256-GCM暗号化

### 15.2 未決定事項

**使用するChatGPTモデル**:
- gpt-4 または gpt-3.5-turbo
- コストとパフォーマンスのバランスで判断

**ローディングアニメーション**:
- シンプルなスピナー
- またはドット3つの点滅アニメーション

---

**基本設計書 終わり**
