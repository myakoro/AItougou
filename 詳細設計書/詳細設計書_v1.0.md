# 詳細設計書（最終）SyncAI

本書は **要件定義書を正**とし、修正版の基本設計書・詳細設計書を前提に、
**Google Antigravity（動的実装）** と **Windsurf（UI実装）** にそのまま渡せる
「判断不要な契約仕様」をまとめたものである。

---

## 1. 全体前提（確定事項）

- AI構成
  - ChatGPT：会話履歴あり
  - Perplexity：単発問い合わせ
- 実行方式：並列
- 統合：**両AI成功時のみ実施**
- フェイル方針：**フェイルソフト**
- スレッド削除：論理削除（一覧非表示・復元なし）
- エクスポート機能：なし
- 統合プロンプト：実装内固定（将来拡張コメントのみ）

---

## 2. フェイルソフト仕様（確定）

| ChatGPT | Perplexity | 挙動 |
|------|-----------|------|
| 成功 | 成功 | 統合プロンプトで再問い合わせし、統合回答を返す |
| 成功 | 失敗 | ChatGPT回答をそのまま返す＋失敗通知 |
| 失敗 | 成功 | Perplexity回答をそのまま返す＋失敗通知 |
| 失敗 | 失敗 | エラーとして終了 |

---

## 3. スレッド仕様（確定）

### 3.1 新規スレッド
- 初期タイトル：自動生成（未確定時は空）
- 初期表示文言：
  > 調査内容を入力してください

### 3.2 削除
- 物理削除は行わない
- `isDeleted = true` として保持
- 一覧・検索・通常表示からは除外
- ゴミ箱UI・復元機能なし

---

## 4. 履歴制御仕様（重要）

### 4.1 保存と参照の違い
- 保存：全履歴保存（トークン消費なし）
- AI参照：制限あり（トークン消費対象）

### 4.2 ChatGPTに渡す履歴（確定）
- 対象：同一スレッド内の会話
- 上限：**直近10往復**
- セーフティ：**合計文字数が 12,000 文字を超えた場合は古い順に除外**

※ Perplexityには履歴を渡さない

---

## 5. Antigravity 向け実装契約（ロジック）

### 5.1 提供API（IPC/SDK）

```ts
sendMessage(
  threadId: string,
  userText: string
): Promise<{
  status: ProcessingStatus
  finalAnswer?: string
  notices?: string[]
  error?: AppError
}>
```

```ts
getThreads(): ThreadSummary[]
getThread(threadId: string): ThreadDetail
createThread(): ThreadSummary
deleteThread(threadId: string): void

saveApiKeys(keys): void
getApiKeyStatus(): { chatgpt: boolean; perplexity: boolean }
```

### 5.2 ProcessingStatus

```ts
type ProcessingStatus =
  | 'idle'
  | 'querying_chatgpt'
  | 'querying_perplexity'
  | 'integrating'
  | 'completed'
  | 'error'
```

### 5.3 エラー契約
- 両AI失敗時のみ `error` を返す
- 片方失敗時は `notices` のみ

---

## 6. Windsurf 向けUI契約（表示ルール）

### 6.1 表示原則
- 本文表示：常に `finalAnswer`
- 補足表示：`notices` をトースト等で表示
- エラー時：本文非表示、エラーダイアログ表示

### 6.2 状態表示

| status | UI表示 |
|------|--------|
| querying_chatgpt | ChatGPTに問い合わせ中 |
| querying_perplexity | Perplexityに問い合わせ中 |
| integrating | 回答を統合中 |
| completed | 回答表示 |
| error | エラー表示 |

---

## 7. 受け入れ基準（Acceptance Criteria）

- APIキー未設定で送信不可、設定導線を表示
- ChatGPT成功・Perplexity失敗でも回答は表示される
- 両AI失敗時のみエラー扱い
- 履歴は10往復＋文字数上限を超えない
- 削除スレッドは一覧に表示されない

---

## 8. 実装メモ（将来拡張）

- 履歴上限は定数化（将来 5 / 15 へ変更可能）
- 統合プロンプトはコード内定義（外部化余地あり）

---

---

# 付録A：フェイルソフト動作仕様（契約）

本付録は UI 実装（Windsurf）および動的実装（Antigravity）が
**判断を挟まずに同一挙動を実現するための契約仕様**である。

| ChatGPT | Perplexity | 最終回答 | 通知 | エラー |
|------|-----------|---------|------|------|
| 成功 | 成功 | 統合回答 | なし | なし |
| 成功 | 失敗 | ChatGPT回答 | Perplexity失敗通知 | なし |
| 失敗 | 成功 | Perplexity回答 | ChatGPT失敗通知 | なし |
| 失敗 | 失敗 | なし | なし | エラー表示 |

---

# 付録B：ProcessingStatus と UI 表示対応（契約）

| ProcessingStatus | UI表示文言 |
|------------------|------------|
| idle | 入力待ち |
| querying_chatgpt | ChatGPTに問い合わせ中 |
| querying_perplexity | Perplexityに問い合わせ中 |
| integrating | 回答を統合中 |
| completed | 回答表示 |
| error | エラーが発生しました |

UI は **status のみを監視して表示を切り替える**。

---

# 付録C：UI ⇄ ロジック インターフェース（契約）

## メッセージ送信

```ts
sendMessage(
  threadId: string,
  userText: string
): Promise<{
  status: ProcessingStatus
  finalAnswer?: string
  notices?: string[]
  error?: AppError
}>
```

- UI は finalAnswer を本文として表示する
- notices は補足通知（トースト等）として表示する
- error が返却された場合、本文は表示しない

---

## スレッド操作

```ts
getThreads(): ThreadSummary[]
getThread(threadId: string): ThreadDetail
createThread(): ThreadSummary
deleteThread(threadId: string): void
```

- deleteThread は論理削除のみ
- 削除スレッドは一覧に表示しない

---

# 付録D：履歴制御仕様（契約）

- ChatGPT に渡す履歴：同一スレッドの **直近10往復**
- 合計文字数が **12,000文字** を超える場合は古い順に除外
- Perplexity には履歴を渡さない

---

以上。


