# 詳細設計書_SyncAI_v2.0.1（最終版）

## 1. 本書の位置づけ
本書は以下を正として作成する。
- 要件定義書_SyncAI_v2.0
- 基本設計書_SyncAI_v2.0.1

本書は、SyncAI v2.0 の詳細設計を定義し、
実装者（Antigravity）が一切の判断・解釈を行わずに実装できる状態を作ることを目的とする。
本書に記載のない挙動は「実装してはならない」。

---

## 2. 固定前提（変更禁止）

- 要件定義・基本設計の内容は変更しない
- UIは Electron + React に固定
- UI文言はすべて日本語
- スレッド削除は論理削除のみ
- 外部AI失敗時はフェイルソフト
- 自動リトライは行わない
- v1.0データの移行は行わない

---

## 3. 状態定義（閉じた列挙・追加禁止）

### 3.1 処理状態（status）

| 状態 | 説明 |
|---|---|
| idle | 待機中 |
| classifying | 質問分類中 |
| generating | ChatGPTによる回答生成中 |
| researching | Perplexityによる調査中 |
| completed | 表示完了 |
| failed | 両方失敗 |

※ 上記以外の状態を定義・使用してはならない

---

## 4. UI ⇄ ロジック契約（厳守）

### 4.1 UI（Windsurf）責務
- ユーザー入力受付
- 処理状態の表示
- 通知の表示（日本語固定）
- ロジックから返却された結果のみ表示

UIは以下を行ってはならない。
- AI呼び出し
- 状態遷移の判断
- 例外・エラー内容の解釈

### 4.2 ロジック（Antigravity）責務
- 状態遷移管理
- 質問分類
- AI呼び出し制御
- フェイルソフト制御
- 永続化
- UI通知種別の決定

---

## 5. スレッド削除仕様（論理削除・固定）

### 5.1 削除処理
- threads.is_deleted = 1
- threads.deleted_at = 現在時刻（ISO8601）

### 5.2 ガード仕様
- is_deleted = 1 のスレッドは取得不可
- 取得要求があった場合、ロジックは NOT_FOUND を返す

### 5.3 UI表示
- 成功通知：「スレッドを削除しました」
- 参照不可：「スレッドが見つかりません」

※ 物理削除・復元処理は一切実装しない

---

## 6. 質問分類・AI処理フロー

### 6.1 共通
1. status = classifying
2. TYPE_A / TYPE_B を判定

### 6.2 TYPE_A
1. status = generating
2. ChatGPT呼び出し
3. 成功／失敗判定

### 6.3 TYPE_B
1. status = generating
2. ChatGPT呼び出し
3. status = researching
4. Perplexity呼び出し
5. 結果統合

---

## 7. フェイルソフト仕様（最重要）

| ChatGPT | Perplexity | 保存内容 | 画面表示 | 通知 |
|---|---|---|---|---|
| 成功 | 成功 | 両方 | 最終回答 | なし |
| 成功 | 失敗 | ChatGPTのみ | ChatGPT回答 | 調査に失敗したため、回答のみ表示しました |
| 失敗 | 成功 | Perplexityのみ | 調査結果 | 回答の生成に失敗したため、調査結果を表示しました |
| 失敗 | 失敗 | なし | 表示なし | 処理に失敗しました。時間をおいて再度お試しください |

※ TYPE_A で ChatGPT 失敗は「両方失敗」と同義

---

## 8. 永続化仕様

### 8.1 保存ルール
- 成功したデータのみ保存する
- 片方成功でも保存する
- 両方失敗時は保存しない

### 8.2 Perplexity保存形式（JSON固定）
```json
{
  "answer": "string",
  "sources": ["https://example.com"]
}
```

- sources は必須（空配列不可）
- URL以外の文字列は禁止

---

## 9. モデル一覧取得仕様

- アプリ起動時に1回のみ実行
- GitHubから models.json を取得
- タイムアウト：5秒
- 失敗時：ローカル models.json を使用
- ユーザー通知は行わない
- 実行結果はメモリ上に保持する

---

## 10. リトライ・再実行

- 自動リトライは禁止
- ユーザー操作による再送信のみ許可
- 再送信時は新規処理として扱う

---

## 11. 受け入れ基準（最低限）

- TYPE_A：成功／失敗
- TYPE_B：成功／片失敗（2パターン）／両失敗
- 削除済みスレッドがUIに表示されない
- UIに英語表記が一切出ない
- 1.0と同等のUXで操作できる

---

## 12. 禁止事項（違反＝不具合）

- 状態の追加・削除
- 物理削除
- 英語UI文言の表示
- 自動リトライ
- 要件・設計の解釈・補完

---

## 13. 完了条件

- 本書の全項目が実装されていること
- 実装者の判断箇所が存在しないこと
- v1.0運用仕様と矛盾がないこと
